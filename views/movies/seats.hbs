<script src="https://cdn.tailwindcss.com"></script>
<script>
    // Настройка Tailwind CSS для использования шрифта Inter (предполагаем, что он используется в других частях приложения)
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                colors: {
                    'primary-red': '#D12229', // Основной красный цвет (как в CinemaBox)
                    'dark-bg': '#1E1E1E', // Основной темный фон
                    'dark-card': '#252525', // Фон карточек и панелей
                    'text-light': '#F0F0F0',
                    'text-muted': '#A0A0A0',
                }
            }
        }
    }
</script>

<style>
    /* Стили для страницы деталей билета */
    .ticket-view-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        background-color: #252525; /* Темный фон для карточки */
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
    }
    .ticket-header { border-bottom: 2px dashed #444; padding-bottom: 1rem; margin-bottom: 1.5rem; }
    .ticket-info p strong { color: #D12229; }
    .qr-code-section { border: 1px solid #333; padding: 1rem; border-radius: 10px; text-align: center; }

    /* Стили схемы зала (минимальные, для отличия) */
    .seat-view-row { display: flex; gap: 4px; justify-content: center; margin-bottom: 4px; }
    .seat-view {
        width: 20px; height: 20px;
        border-radius: 4px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.6rem;
        font-weight: bold;
        transition: all 0.1s;
    }
    .seat-view.booked { background-color: #444; color: #888; }
    .seat-view.available { background-color: #333; color: #555; }
    .seat-view.user-seat { background-color: #D12229; color: white; border: 2px solid #FF4D50; transform: scale(1.2); }
    .row-view-label { width: 20px; text-align: right; color: #aaa; font-size: 0.7rem; }
    /* Этот индикатор заменен на screen-indicator в теле шаблона */
    .screen-view-indicator { width: 100%; height: 10px; background-color: #D12229; border-radius: 5px; margin-bottom: 1rem; }


    /* Базовые стили для темной темы и шрифта Inter */
    .seat-selection-page {
        background-color: #1E1E1E; /* Основной фон */
        color: #F0F0F0;
        min-height: calc(100vh - 150px); /* Учитываем высоту шапки/подвала */
        font-family: 'Inter', sans-serif;
        padding: 2rem 1rem;
    }

    /* Элементы заголовка и сводки */
    .seat-selection-header h1 {
        color: #F0F0F0;
        border-bottom: 2px solid #333;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }

    .back-link {
        color: #D12229;
        transition: color 0.2s;
        font-weight: 500;
    }
    .back-link:hover {
        color: #FF4D50;
    }

    /* Стиль для кнопки выбора времени */
    .time-button-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Адаптивная сетка */
        gap: 0.75rem;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 0 1rem;
    }
    .time-button {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
        background-color: #333; /* Темнее для неактивного состояния */
        color: #F0F0F0;
        border: 2px solid #444;
        min-width: 120px;
        text-align: center;
    }
    .time-button:hover {
        background-color: #4A4A4A;
        border-color: #D12229;
        transform: translateY(-1px);
    }
    .time-button.active {
        background-color: #D12229;
        border-color: #FF4D50;
        color: white;
        box-shadow: 0 4px 15px rgba(209, 34, 41, 0.4);
        transform: scale(1.02);
        pointer-events: none; /* Отключаем клик по активной кнопке */
    }

    /* Индикатор экрана - ИСПРАВЛЕНО */
    .screen-indicator {
        width: 100%;
        height: 30px;
        background: linear-gradient(to right, #D12229, #8c171b);
        color: white;
        text-align: center;
        line-height: 15px;
        font-size: 1rem;
        border-radius: 5px 5px 0 0;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(209, 34, 41, 0.4);
        letter-spacing: 0.2em;
    }

    /* Схема мест */
    .seating-map-wrapper {
        overflow-x: auto;
        padding: 1rem 0;
        max-width: 100%;
    }

    .seat-row {
        display: flex;
        align-items: center;
        gap: 4px; /* Уменьшаем горизонтальный зазор */
        justify-content: center; /* Центрируем ряд */
        margin-bottom: 5px;
    }

    .row-label {
        width: 25px; /* Уменьшаем ширину */
        min-width: 25px;
        line-height: 28px; /* Соответствует новой высоте сиденья */
        text-align: right;
        font-weight: bold;
        color: #A0A0A0;
        margin-right: 5px; /* Уменьшаем отступ */
        font-size: 0.9rem;
    }

    .seat {
        width: 28px; /* Уменьшаем размер */
        height: 28px;
        background-color: #383838;
        border: 2px solid #555;
        border-radius: 6px; /* Уменьшаем скругление */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem; /* Уменьшаем шрифт номера места */
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        color: #ccc;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    .seat.available:hover {
        background-color: #4A4A4A;
        border-color: #D12229;
        transform: scale(1.1);
    }

    .seat.selected {
        background-color: #D12229;
        border-color: #FF4D50;
        color: white;
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(209, 34, 41, 0.7);
    }

    .seat.booked {
        background-color: #0d0d0d;
        border-color: #333;
        color: #666;
        cursor: not-allowed;
        opacity: 0.7;
        pointer-events: none;
    }

    /* Панель бронирования */
    .booking-summary-panel {
        background-color: #252525;
        border: 1px solid #333;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .summary-details span {
        font-weight: 700;
        color: #D12229;
        font-size: 1.3rem;
    }

    .selected-seats-list span {
        display: inline-block;
        background-color: #333;
        color: #F0F0F0;
        padding: 4px 8px;
        border-radius: 5px;
        margin: 4px;
        font-size: 0.9rem;
    }

    .btn-primary-custom {
        background-color: #D12229;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: bold;
        transition: all 0.2s;
    }
    .btn-primary-custom:hover:not(:disabled) {
        background-color: #FF4D50;
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(209, 34, 41, 0.5);
    }
    .btn-primary-custom:disabled {
        background-color: #555;
        cursor: not-allowed;
        opacity: 0.7;
    }

    /* Стили для загрузки */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(30, 30, 30, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        border-radius: 12px;
    }
    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #D12229;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="seat-selection-page page-container main-wrapper">
    <div class="text-center mb-10">
        <a id="back-link" href="#" class="back-link inline-block mb-4 text-text-muted hover:text-primary-red">
            &larr; Назад к фильму (Смотреть все сеансы)
        </a>
        <h1 id="movie-title" class="text-3xl font-extrabold text-text-light">Загрузка...</h1>

        <div class="mt-6 mb-8 p-4 bg-dark-card rounded-xl shadow-lg max-w-lg mx-auto relative">
            <div id="time-loading-overlay" class="loading-overlay">
                <div class="spinner"></div>
            </div>

            <h2 class="text-xl font-semibold mb-3 text-text-light">Выберите время сеанса:</h2>
            <div id="time-selection-buttons" class="flex flex-col items-center gap-2">
            </div>
        </div>

        <div id="screening-details" class="screening-details-summary text-text-muted mt-2 space-y-1">
            <p><strong>Зал:</strong> <span id="hall-name">—</span></p>
            <p><strong>Время:</strong> <span id="screening-time">—</span></p>
            <p><strong>Цена:</strong>
                <span id="base-price" class="font-bold text-primary-red">0.00</span> BYN за место
            </p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto flex flex-col lg:flex-row gap-8">
        <div class="lg:w-3/4 w-full bg-dark-card p-6 rounded-xl flex flex-col items-center relative">
            <div id="seating-loading-overlay" class="loading-overlay">
                <div class="spinner"></div>
            </div>
            <div class="screen-indicator">ЭКРАН</div>
            <div class="seating-map-wrapper w-full">
                <div id="seating-map" class="seating-map mx-auto">
                    <div class="text-center text-text-muted pt-8">Выберите время сеанса для загрузки схемы зала.</div>
                </div>
            </div>

            <div class="mt-8 flex justify-center gap-6 text-sm">
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-[#383838] border-2 border-[#555] mr-2"></div>
                    Свободно
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-[#D12229] border-2 border-[#FF4D50] mr-2"></div>
                    Выбрано
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-[#0d0d0d] border-2 border-[#333] mr-2"></div>
                    Занято
                </div>
            </div>
        </div>

        <div class="lg:w-1/4 w-full booking-summary-panel p-6 h-fit sticky top-5">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Ваш заказ</h2>
            <div class="summary-details space-y-3">
                <p class="text-lg">Выбрано мест: <span id="selected-count">0</span></p>
                <p class="text-xl">Сумма к оплате: <span id="total-price" class="text-primary-red">0.00</span> BYN</p>
            </div>

            <div id="selected-seats-list" class="selected-seats-list mt-4 mb-6 min-h-[30px] border-t border-b border-gray-700 py-3 text-text-muted">
                <span class="text-sm">Места не выбраны</span>
            </div>

            <button id="book-button" class="btn-primary-custom w-full" disabled>
                Оплатить
            </button>

            <div id="booking-message" class="booking-message text-center mt-4 text-sm font-semibold"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', initApp);

    // =========================================================
    // 1. КОНСТАНТЫ и ИНИЦИАЛИЗАЦИЯ ДАННЫХ
    // =========================================================
    const API_BASE = '/movies/api';

    // *** КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: БЕЗОПАСНОЕ ПАРСИРОВАНИЕ ДАННЫХ ***
    let initialDataJson;
    let movieId;

    try {

        initialDataJson = JSON.parse(`{{{initialData}}}`);
        // movieId берется из контекста роута
        movieId = `{{{movieId}}}`;
    } catch (e) {
        console.error("КРИТИЧЕСКАЯ ОШИБКА ПАРСИНГА initialData. Вероятно, сервер не передал валидный JSON:", e);
        // Fallback: пустые объекты, чтобы избежать ошибок null/undefined далее
        initialDataJson = { screenings: [], initialSeatData: null };
        movieId = '';
    }

    // =========================================================
    // 2. СТАТУС ПРИЛОЖЕНИЯ
    // =========================================================
    // allScreenings теперь массив групп
    let allScreenings = initialDataJson.screenings || [];
    // currentScreeningDetails содержит данные текущего активного сеанса (обновляется при AJAX)
    let currentScreeningDetails = initialDataJson.initialSeatData || null;
    let selectedSeats = [];

    // *** ДОБАВЛЕНО ДЛЯ ОТЛАДКИ (Проверьте эти логи в консоли!) ***
    console.log("Статус загрузки сеансов:", allScreenings.length > 0 ? "Сеансы загружены." : "Сеансы НЕ загружены (allScreenings пуст).");
    console.log("Данные сеансов (allScreenings):", allScreenings);


    // =========================================================
    // 3. ДОСТУП К ЭЛЕМЕНТАМ DOM
    // =========================================================
    const titleElement = document.getElementById('movie-title');
    const timeButtonsContainer = document.getElementById('time-selection-buttons');
    const timeLoadingOverlay = document.getElementById('time-loading-overlay'); // <-- ДОБАВЛЕНО
    const seatingLoadingOverlay = document.getElementById('seating-loading-overlay');
    const hallNameSpan = document.getElementById('hall-name');
    const screeningTimeSpan = document.getElementById('screening-time');
    const basePriceSpan = document.getElementById('base-price');
    const seatingMap = document.getElementById('seating-map');
    const selectedCountSpan = document.getElementById('selected-count');
    const totalPriceSpan = document.getElementById('total-price');
    const bookButton = document.getElementById('book-button');
    const bookingMessageDiv = document.getElementById('booking-message');
    const selectedSeatsListDiv = document.getElementById('selected-seats-list');
    const backLink = document.getElementById('back-link');

    // =========================================================
    // 4. ФУНКЦИИ РЕНДЕРИНГА И ЛОГИКИ ВЫБОРА МЕСТ
    // =========================================================

    function updateScreeningDetails() {
        if (!currentScreeningDetails) {
            hallNameSpan.textContent = '—';
            screeningTimeSpan.textContent = '—';
            basePriceSpan.textContent = '0.00';
            return;
        }
        // startTime содержит форматированную полную дату (ДД.ММ. ЧЧ:ММ)
        screeningTimeSpan.textContent = currentScreeningDetails.startTime;
        hallNameSpan.textContent = currentScreeningDetails.hall;
        basePriceSpan.textContent = currentScreeningDetails.basePrice ? currentScreeningDetails.basePrice.toFixed(2) : '0.00';
    }

    function updateSummary() {
        const count = selectedSeats.length;
        const price = currentScreeningDetails ? currentScreeningDetails.basePrice : 0;
        const total = (count * price);
        const totalDisplay = total.toFixed(2);

        selectedCountSpan.textContent = count;
        totalPriceSpan.textContent = totalDisplay;

        selectedSeats.sort((a, b) => {
            const [rowA, seatA] = a.split('-').map(Number);
            const [rowB, seatB] = b.split('-').map(Number);
            if (rowA !== rowB) return rowA - rowB;
            return seatA - seatB;
        });

        bookButton.disabled = count === 0 || !currentScreeningDetails;
        bookingMessageDiv.textContent = '';

        if (count === 0) {
            selectedSeatsListDiv.innerHTML = '<span class="text-sm">Места не выбраны</span>';
        } else {
            selectedSeatsListDiv.innerHTML = selectedSeats.map(key => {
                const [row, seat] = key.split('-');
                return `<span>Ряд ${row}, Место ${seat}</span>`;
            }).join('');
        }
    }

    function renderSeatingMap() {
        // !!! КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверка DOM элемента (устраняет TypeError)
        if (!seatingMap) {
            console.error('Критическая ошибка: Элемент #seating-map не найден в DOM.');
            return;
        }

        if (!currentScreeningDetails) {
            seatingMap.innerHTML = '<div class="text-center text-text-muted pt-8">Выберите время сеанса.</div>';
            return;
        }

        const { rowsCount, seatsPerRow, bookedSeatKeys } = currentScreeningDetails;

        if (rowsCount <= 0 || seatsPerRow <= 0) {
            seatingMap.innerHTML = '<div class="text-center text-text-muted mt-4">Ошибка: Некорректные размеры зала.</div>';
            return;
        }

        seatingMap.innerHTML = '';
        const fragment = document.createDocumentFragment();

        for (let row = 1; row <= rowsCount; row++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'seat-row';

            const rowLabel = document.createElement('div');
            rowLabel.className = 'row-label';
            rowLabel.textContent = row;
            rowDiv.appendChild(rowLabel);

            for (let seatNum = 1; seatNum <= seatsPerRow; seatNum++) {
                const seatKey = `${row}-${seatNum}`;
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.textContent = seatNum;
                seatDiv.dataset.key = seatKey;

                if (bookedSeatKeys.includes(seatKey)) {
                    seatDiv.classList.add('booked');
                } else {
                    seatDiv.classList.add('available');
                    seatDiv.addEventListener('click', toggleSeatSelection);
                }

                if (selectedSeats.includes(seatKey)) {
                    seatDiv.classList.add('selected');
                }

                rowDiv.appendChild(seatDiv);
            }
            fragment.appendChild(rowDiv);
        }
        seatingMap.appendChild(fragment);
        updateSummary();
    }

    function toggleSeatSelection(event) {
        const seatDiv = event.target.closest('.seat');
        if (!seatDiv || seatDiv.classList.contains('booked') || !currentScreeningDetails) return;

        const seatKey = seatDiv.dataset.key;

        if (seatDiv.classList.contains('selected')) {
            seatDiv.classList.remove('selected');
            selectedSeats = selectedSeats.filter(key => key !== seatKey);
        } else {
            seatDiv.classList.add('selected');
            selectedSeats.push(seatKey);
        }

        updateSummary();
    }
    // =========================================================
    // 5. ЛОГИКА ВЫБОРА ВРЕМЕНИ СЕАНСА (AJAX)
    // =========================================================

    async function loadScreening(screeningId) {
        if (!screeningId) return;

        document.querySelectorAll('.time-button').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.querySelector(`.time-button[data-id="${screeningId}"]`);
        if (activeBtn) activeBtn.classList.add('active');

        seatingLoadingOverlay.style.display = 'flex';
        seatingMap.innerHTML = '<div class="text-center text-text-muted pt-8">Загрузка схемы зала...</div>';
        bookButton.disabled = true;
        selectedSeats = []; // Сбрасываем выбранные места

        try {
            const response = await fetch(`${API_BASE}/seats/${screeningId}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Ошибка HTTP: ${response.status}`);
            }
            const data = await response.json();

            currentScreeningDetails = data;

            updateScreeningDetails();
            renderSeatingMap();

        } catch (error) {
            console.error('Ошибка загрузки схемы мест:', error);
            seatingMap.innerHTML = `<div class="text-center text-red-500 pt-8">Не удалось загрузить схему: ${error.message}</div>`;
            currentScreeningDetails = null;
            updateScreeningDetails();
        } finally {
            seatingLoadingOverlay.style.display = 'none';
            updateSummary();
        }
    }

    function renderTimeButtons() {
        timeButtonsContainer.innerHTML = ''; // <-- Очищаем контейнер

        if (allScreenings.length === 0) {
            timeButtonsContainer.innerHTML = '<p class="text-red-500 font-bold">Нет доступных сеансов.</p>';
            return;
        }

        const initialId = currentScreeningDetails ? currentScreeningDetails.id : null;
        const fragment = document.createDocumentFragment();

        allScreenings.forEach(dayGroup => {
            // Заголовок дня
            const header = document.createElement('h3');
            header.className = 'w-full text-center text-lg font-bold text-text-light mt-4 mb-2 pt-2 border-t border-gray-700 first:mt-0 first:pt-0 first:border-t-0';
            header.textContent = dayGroup.dateLabel + ':';
            fragment.appendChild(header);

            // Контейнер кнопок (используем класс time-button-group с grid)
            const dayButtonsContainer = document.createElement('div');
            dayButtonsContainer.className = 'time-button-group';

            dayGroup.screenings.forEach(scr => {
                const button = document.createElement('button');

                // scr.startTime содержит ТОЛЬКО время (например, "19:00")
                button.className = 'time-button';
                button.textContent = `${scr.startTime} (${scr.hall})`;
                button.dataset.id = scr.id;
                button.dataset.fullTime = scr.fullDisplayTime; // Для удобства, если потребуется

                if (scr.id === initialId) {
                    button.classList.add('active');
                }

                button.addEventListener('click', () => loadScreening(scr.id));
                dayButtonsContainer.appendChild(button);
            });

            fragment.appendChild(dayButtonsContainer);
        });

        timeButtonsContainer.appendChild(fragment);
    }


    /** Инициализация приложения. */
    async function initApp() {
        seatingLoadingOverlay.style.display = 'none';

        // 1. Установка заголовка
        titleElement.textContent = currentScreeningDetails?.movieTitle || 'Выбор мест';

        // 2. Установка ссылки "Назад"
        backLink.href = `/movies/${movieId}`;

        // 3. Рендеринг кнопок времени (с группировкой)
        renderTimeButtons();

        // ИЗМЕНЕНИЕ 5: Скрываем оверлей загрузки времени после рендеринга кнопок
        if (timeLoadingOverlay) {
            timeLoadingOverlay.style.display = 'none';
        }

        // 4. Рендеринг схемы мест и деталей для первого сеанса (если данные есть)
        if (currentScreeningDetails) {
            updateScreeningDetails();
            renderSeatingMap();
            // Показываем, что первый сеанс активен
            const initialButton = document.querySelector(`.time-button[data-id="${currentScreeningDetails.id}"]`);
            if (initialButton) {
                initialButton.classList.add('active');
            }
        } else {
            // Если initialSeatData пуст, но сеансы есть, предлагаем выбрать
            if (allScreenings.length > 0) {
                seatingMap.innerHTML = '<div class="text-center text-text-muted pt-8">Выберите время сеанса для загрузки схемы зала.</div>';
            } else {
                seatingMap.innerHTML = '<div class="text-center text-red-500 pt-8">Нет доступных сеансов.</div>';
            }
            updateScreeningDetails();
            bookButton.disabled = true;
        }
    }


    // =========================================================
    // 6. ФУНКЦИЯ ОПЛАТЫ ЮKASSA (ВОССТАНОВЛЕНА)
    // =========================================================

    async function handleBooking() {
        // Используем динамические данные текущего сеанса
        if (!currentScreeningDetails || selectedSeats.length === 0 || bookButton.disabled) return;

        const totalAmount = (selectedSeats.length * currentScreeningDetails.basePrice);

        if (totalAmount <= 0) {
            bookingMessageDiv.textContent = 'Ошибка: Сумма к оплате должна быть больше 0.';
            bookingMessageDiv.classList.add('text-red-500');
            return;
        }

        bookButton.disabled = true;
        bookButton.textContent = 'Перенаправление на оплату...';
        bookingMessageDiv.textContent = 'Подготовка платежной сессии ЮKassa...';
        bookingMessageDiv.className = 'booking-message text-text-muted';

        // Формирование метаданных для ЮKassa
        const temporaryTicketIds = selectedSeats.map(key => ({
            // Используем ID текущего активного сеанса
            screeningId: currentScreeningDetails.id,
            seatKey: key, // "ряд-место"
            price: currentScreeningDetails.basePrice,
        }));


        const orderDescription = `Билеты на фильм "${currentScreeningDetails.movieTitle}" (${selectedSeats.length} шт.)`;

        try {
            // 1. Вызываем роут создания платежа ЮKassa
            const response = await fetch('/payment/place-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    totalAmount: totalAmount.toFixed(2), // ЮKassa требует формат строки с 2 знаками
                    orderDescription: orderDescription,
                    ticketIds: temporaryTicketIds,
                }),
            });

            const result = await response.json();

            if (response.ok) {
                const redirectUrl = result.url;

                bookingMessageDiv.textContent = 'Перенаправление на страницу оплаты ЮKassa...';
                bookingMessageDiv.classList.remove('text-text-muted', 'text-red-500');
                bookingMessageDiv.classList.add('text-green-500');

                // 2. Перенаправляем пользователя на ЮKassa
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 500);

            } else {
                // Обработка 401 (Не авторизован)
                if (response.status === 401) {
                    const redirectUrl = result.redirect || '/auth/login';
                    const errorMessage = result.error || 'Необходимо войти в систему для оформления заказа.';

                    bookingMessageDiv.textContent = errorMessage;
                    bookingMessageDiv.classList.add('text-red-500');
                    bookButton.textContent = 'Авторизация...';

                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1000);
                    return;
                }

                // Общая ошибка
                bookingMessageDiv.textContent = result.error || 'Ошибка при создании платежа. Попробуйте еще раз.';
                bookingMessageDiv.classList.add('text-red-500');
                bookingMessageDiv.classList.remove('text-text-muted', 'text-green-500');
                bookButton.disabled = false;
                bookButton.textContent = 'Оплатить';
            }

        } catch (error) {
            console.error('Payment creation failed (Network/Critical Error):', error);
            bookingMessageDiv.textContent = 'Критическая ошибка сети. Проверьте соединение.';
            bookingMessageDiv.classList.add('text-red-500');
            bookingMessageDiv.classList.remove('text-text-muted', 'text-green-500');
            bookButton.disabled = false;
            bookButton.textContent = 'Оплатить';
        }
    }

    bookButton.addEventListener('click', handleBooking);
</script>
