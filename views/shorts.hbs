<div id="shorts-data" style="display: none;" data-shorts='{{json shorts}}'></div>
<div id="filter-data" data-movie-id="{{filterMovieId}}"></div>
<div class="shorts-feed-container">
    {{#if message}}
        <div class="no-shorts-message">{{message}}</div>
    {{else}}
    {{!-- –≠–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ (—Ç–æ–ª—å–∫–æ 3 —à—Ç.: –ø—Ä–µ–¥., —Ç–µ–∫—É—â., —Å–ª–µ–¥.) --}}
        <div id="dynamic-short-feed">
        </div>
    {{/if}}
</div>

<style>
    /* –°–∫—Ä—ã–≤–∞–µ–º —Ö–µ–¥–µ—Ä –∏ —Ñ—É—Ç–µ—Ä, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –±—ã–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ—Ö–æ–∂–∞ –Ω–∞ Shorts */
    body {
        overflow: hidden;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å */
        margin: 0;
        padding: 0;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–µ–æ */
    .shorts-feed-container {
        width: 100vw;
        height: 100vh;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        flex-grow: 1;
        /* –£–±–∏—Ä–∞–µ–º scrollbar, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }
    .shorts-feed-container::-webkit-scrollbar {
        display: none; /* Chrome, Safari and Opera */
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    #dynamic-short-feed {
        height: 100%;
        width: 100%;
    }

    /* –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –∑–∞–Ω–∏–º–∞–µ—Ç —Ä–æ–≤–Ω–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    .short-item {
        width: 100vw;
        height: 100vh;
        position: relative;
        scroll-snap-align: start;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #000;
    }

    /* –í–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã */
    .short-video-wrapper {
        height: 100%;
        max-width: 750px;
        width: 100%;
        position: relative;
    }

    /* –°–∞–º –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç */
    .short-video {
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: #000;
    }

    /* –ù–∞–ª–æ–∂–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
    .video-overlay {
        position: absolute;
        bottom: 100px;
        max-width: 750px;
        width: 100%;
        padding: 20px 20px;
        background: rgba(0,0,0,0.8);
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        box-sizing: border-box;
    }

    /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –¥–ª—è —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Å–ª–∏–≤–∞–ª—Å—è —Å –Ω–∏–∑–æ–º */
    .video-details {
        margin-bottom: 5px;
        align-self: center;
    }

    .short-title {
        font-size: 24px;
        margin-bottom: 5px;
        color: #fff;
    }

    .movie-link a {
        color: #e50914;
        text-decoration: none;
        font-weight: bold;
    }

    .movie-link a:hover {
        text-decoration: underline;
    }

    .no-shorts-message {
        color: #fff;
        text-align: center;
        padding-top: 50vh;
        transform: translateY(-50%);
        font-size: 20px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –∑–≤—É–∫–∞ (–≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª) */
    .mute-toggle-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.2s;
        z-index: 10;
    }

    .mute-toggle-btn:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    .mute-toggle-btn .icon {
        font-size: 20px;
        line-height: 1;
    }

    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ mute */
    .mute-toggle-btn.muted .icon {
        content: 'üîá';
    }
    .mute-toggle-btn.active .icon {
        content: 'üîä';
    }

    .delete-short-form {
        margin-left: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –¥–µ—Ç–∞–ª–µ–π –≤–∏–¥–µ–æ */
        align-self: flex-end; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –Ω–∏–∂–Ω–µ–º—É –∫—Ä–∞—é */
    }

    .btn-delete-short {
        background-color: rgba(229, 9, 20, 0.7); /* –ö—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è */
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.2s;
        font-size: 18px;
        line-height: 1; /* –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —ç–º–æ–¥–∑–∏ */
    }

    .btn-delete-short:hover {
        background-color: #ff0000;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dataContainer = document.getElementById('shorts-data');
        if (!dataContainer) return;

        const filterDataContainer = document.getElementById('filter-data');
        const isFiltered = !!filterDataContainer.getAttribute('data-movie-id');

        const allShorts = JSON.parse(dataContainer.getAttribute('data-shorts'));
        if (allShorts.length === 0) return;

        const dynamicFeed = document.getElementById('dynamic-short-feed');
        const feedContainer = document.querySelector('.shorts-feed-container');
        const totalShorts = allShorts.length;
        let currentIndex = 0;

        // –ì–õ–û–ë–ê–õ–¨–ù–´–ô –§–õ–ê–ì: –≤–∫–ª—é—á–µ–Ω –ª–∏ –∑–≤—É–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ
        let globalSoundEnabled = false;
        const videoMuteStates = {};

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —è–∫–æ—Ä—è
        const hash = window.location.hash.substring(1);
        if (hash) {
            const initialIndex = allShorts.findIndex(s => String(s.shortid) === hash);
            if (initialIndex !== -1) {
                currentIndex = initialIndex;
                console.log(`–Ø–∫–æ—Ä—å #${hash} –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å ${currentIndex}`);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ mute –¥–ª—è –≤—Å–µ—Ö —à–æ—Ä—Ç—Å–æ–≤
        allShorts.forEach(short => {
            videoMuteStates[short.shortid] = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω
        });

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï–ú ---
        const tryPlayVideo = (video, shortId) => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤—É–∫–∞
            let shouldBeMuted;

            if (globalSoundEnabled) {
                // –ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –∑–≤—É–∫ –≤–∫–ª—é—á–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                shouldBeMuted = videoMuteStates[shortId] === true;
            } else {
                // –ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω, –∑–≤—É–∫ –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω
                shouldBeMuted = true;
            }

            video.muted = shouldBeMuted;

            const muteBtn = video.closest('.short-item')?.querySelector('.mute-toggle-btn');
            if (muteBtn) {
                const iconSpan = muteBtn.querySelector('.icon');
                if (video.muted) {
                    iconSpan.textContent = 'üîá';
                    muteBtn.classList.remove('active');
                    muteBtn.title = '–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                } else {
                    iconSpan.textContent = 'üîä';
                    muteBtn.classList.add('active');
                    muteBtn.title = '–í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                }
            }

            if (video.paused) {
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        if (error.name === "NotAllowedError" || error.name === "AbortError") {
                            video.muted = true;
                            video.play().catch(e => { });
                        }
                    });
                }
            }
        };

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML ---
        const createShortItem = (short, index) => {
            if (!short) return null;

            const shortItem = document.createElement('div');
            shortItem.className = 'short-item';
            shortItem.setAttribute('data-short-id', short.shortid);
            shortItem.setAttribute('data-index', index);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–≤—É–∫–∞
            let isInitiallyMuted;
            if (globalSoundEnabled) {
                // –ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω, –±–µ—Ä–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                isInitiallyMuted = videoMuteStates[short.shortid] === true;
            } else {
                // –ï—Å–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω, –∑–≤—É–∫ –≤—Å–µ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω
                isInitiallyMuted = true;
            }

            const muteIcon = isInitiallyMuted ? 'üîá' : 'üîä';
            const muteClass = isInitiallyMuted ? '' : 'active';
            const movieLinkUrl = `/movies/${short.movieid}`;
            const deleteRedirectParam = isFiltered ? `&fromMovie=${short.movieid}` : '';

            shortItem.innerHTML = `
            <div class="short-video-wrapper">
                <video
                    class="short-video"
                    id="video-${short.shortid}"
                    src="${short.videopath}"
                    ${index === currentIndex ? 'autoplay' : ''}
                    loop
                    playsinline
                    ${isInitiallyMuted ? 'muted' : ''}
                ></video>

                <button class="mute-toggle-btn ${muteClass}" data-video-id="video-${short.shortid}">
                    <span class="icon">${muteIcon}</span>
                </button>
            </div>

            <div class="video-overlay">
                <div class="video-details">
                    <h2 class="short-title">${short.short_title}</h2>
                    <p class="movie-link">–ö —Ñ–∏–ª—å–º—É: <a href="${movieLinkUrl}">${short.movie_title}</a></p>
                </div>
                {{#if isAdmin}}
                <form action="/admin/shorts/${short.shortid}/delete" method="POST" class="delete-short-form"
                          onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —à–æ—Ä—Ç—Å \\'${short.short_title}\\'?');">
                        <button type="submit" class="btn-delete-short" title="–£–¥–∞–ª–∏—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ">
                            <span class="icon">üóëÔ∏è</span>
                        </button>
                </form>
                {{/if}}
            </div>
        `;

            const muteButton = shortItem.querySelector('.mute-toggle-btn');
            const video = shortItem.querySelector('.short-video');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–≤—É–∫–∞
            muteButton.addEventListener('click', (event) => {
                event.stopPropagation();

                // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –î–û –∏–∑–º–µ–Ω–µ–Ω–∏—è
                const wasMuted = video.muted;

                // –ú–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ
                videoMuteStates[short.shortid] = !video.muted;
                video.muted = !video.muted;

                // üî¥ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –í–ö–õ–Æ–ß–ê–ï–ú –∑–≤—É–∫ (–±—ã–ª muted, —Å—Ç–∞–ª unmuted)
                if (wasMuted && !video.muted) {
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥
                    globalSoundEnabled = true;

                    // üî¥ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ –¥–ª—è –í–°–ï–• –≤–∏–¥–µ–æ –≤ –º–∞—Å—Å–∏–≤–µ allShorts
                    // (–∫—Ä–æ–º–µ —Ç–µ—Ö, –≥–¥–µ –∑–≤—É–∫ –±—ã–ª —è–≤–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ä–∞–Ω–µ–µ)
                    allShorts.forEach(s => {
                        // –ï—Å–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ –µ—â–µ –Ω–µ –±—ã–ª–æ —è–≤–Ω–æ–≥–æ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞
                        if (videoMuteStates[s.shortid] !== false) {
                            videoMuteStates[s.shortid] = false; // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
                        }
                    });

                    // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Ç–µ–∫—É—â–∏–µ –≤–∏–¥–µ–æ –≤ DOM
                    dynamicFeed.querySelectorAll('.short-video').forEach(vid => {
                        const vidId = vid.id.replace('video-', '');
                        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–æ—Ä—Ç—Å
                        const currentShort = allShorts.find(s =>
                                s.shortid && String(s.shortid) === vidId
                        );

                        if (currentShort) {
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤—É–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
                            vid.muted = videoMuteStates[currentShort.shortid] === true;

                            const vidMuteBtn = vid.closest('.short-item')?.querySelector('.mute-toggle-btn');
                            if (vidMuteBtn) {
                                const vidIconSpan = vidMuteBtn.querySelector('.icon');
                                if (vid.muted) {
                                    vidIconSpan.textContent = 'üîá';
                                    vidMuteBtn.classList.remove('active');
                                } else {
                                    vidIconSpan.textContent = 'üîä';
                                    vidMuteBtn.classList.add('active');
                                }
                            }
                        }
                    });
                }
                // üî¥ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –í–´–ö–õ–Æ–ß–ê–ï–ú –∑–≤—É–∫
                else if (!wasMuted && video.muted) {
                    // –í—ã–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ —Ç–æ–ª—å–∫–æ —É —ç—Ç–æ–≥–æ –≤–∏–¥–µ–æ
                    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –Ω–µ –º–µ–Ω—è–µ–º, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –≤–∏–¥–µ–æ –æ—Å—Ç–∞–ª–∏—Å—å —Å–æ –∑–≤—É–∫–æ–º
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–∏
                const iconSpan = muteButton.querySelector('.icon');
                if (video.muted) {
                    iconSpan.textContent = 'üîá';
                    muteButton.classList.remove('active');
                    muteButton.title = '–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                } else {
                    iconSpan.textContent = 'üîä';
                    muteButton.classList.add('active');
                    muteButton.title = '–í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                }

                // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑–µ
                if (video.paused) {
                    video.play().catch(e => {});
                }
            });

            // –ö–ª–∏–∫ –Ω–∞ –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–∞—É–∑—ã/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            video.addEventListener('click', (event) => {
                event.stopPropagation();
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            });

            return shortItem;
        };

        // --- –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò ---
        const loadShorts = (scrollToCurrent = true) => {
            dynamicFeed.querySelectorAll('.short-item').forEach(item => {
                const video = item.querySelector('.short-video');
                if (video) {
                    video.pause();
                    if (isFiltered) {
                        video.removeAttribute('src');
                        video.load();
                    }
                }
            });

            dynamicFeed.innerHTML = '';

            let prevIndex, nextIndex;

            if (isFiltered) {
                prevIndex = currentIndex > 0 ? currentIndex - 1 : null;
                nextIndex = currentIndex < totalShorts - 1 ? currentIndex + 1 : null;
            } else {
                prevIndex = (currentIndex - 1 + totalShorts) % totalShorts;
                nextIndex = (currentIndex + 1) % totalShorts;
            }

            const indicesToLoad = [prevIndex, currentIndex, nextIndex].filter(i => i !== null);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –¥–ª—è scroll-snap
            indicesToLoad.forEach(index => {
                const shortData = allShorts[index];
                const item = createShortItem(shortData, index);
                if (item) {
                    dynamicFeed.appendChild(item);
                }
            });

            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
            if (scrollToCurrent) {
                window.requestAnimationFrame(() => {
                    const itemHeight = feedContainer.clientHeight;
                    let targetScrollTop = itemHeight; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º

                    if (isFiltered) {
                        if (currentIndex === 0) {
                            targetScrollTop = 0;
                        } else if (currentIndex === totalShorts - 1) {
                            const loadedCount = indicesToLoad.length;
                            targetScrollTop = itemHeight * (loadedCount - 1);
                        } else {
                            targetScrollTop = itemHeight;
                        }
                    }

                    feedContainer.scrollTop = targetScrollTop;
                });
            }

            const currentVideo = dynamicFeed.querySelector(`.short-item[data-index="${currentIndex}"] .short-video`);
            if (currentVideo) {
                tryPlayVideo(currentVideo, allShorts[currentIndex].shortid);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å —è–∫–æ—Ä–µ–º
            const currentShort = allShorts[currentIndex];
            if (currentShort) {
                const searchParams = new URLSearchParams(window.location.search);
                const newUrl = `${window.location.pathname}?${searchParams.toString()}#${currentShort.shortid}`;
                window.history.replaceState(null, '', newUrl);
            }
        };

        // --- –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –°–ö–†–û–õ–õ–ê ---
        let isScrolling = false;
        let scrollTimeout;

        feedContainer.addEventListener('scroll', () => {
            if (!isScrolling) { isScrolling = true; }
            if (scrollTimeout) clearTimeout(scrollTimeout);

            scrollTimeout = setTimeout(() => {
                const scrollTop = feedContainer.scrollTop;
                const itemHeight = feedContainer.clientHeight;

                let currentElementIndex = Math.round(scrollTop / itemHeight);

                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                const loadedItems = Array.from(dynamicFeed.querySelectorAll('.short-item'));
                if (loadedItems.length === 0) {
                    isScrolling = false;
                    return;
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —ç–ª–µ–º–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –≤ —Ü–µ–Ω—Ç—Ä–µ
                let newIndex = currentIndex;

                if (currentElementIndex >= 0 && currentElementIndex < loadedItems.length) {
                    const currentElement = loadedItems[currentElementIndex];
                    const elementIndex = parseInt(currentElement.getAttribute('data-index'));

                    // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è
                    if (elementIndex !== currentIndex) {
                        newIndex = elementIndex;
                    }
                }

                if (newIndex !== currentIndex) {
                    currentIndex = newIndex;
                    loadShorts(false);

                    window.requestAnimationFrame(() => {
                        const itemHeight = feedContainer.clientHeight;
                        const loadedItems = Array.from(dynamicFeed.querySelectorAll('.short-item'));
                        const currentElementIndex = loadedItems.findIndex(item =>
                                parseInt(item.getAttribute('data-index')) === currentIndex
                        );

                        if (currentElementIndex >= 0) {
                            feedContainer.scrollTop = itemHeight * currentElementIndex;
                        }
                    });
                }

                isScrolling = false;
            }, 100);
        });

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        loadShorts(true);

        // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à ---
        document.addEventListener('keydown', (e) => {
            let newIndex = currentIndex;

            if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                e.preventDefault();
                if (isFiltered) {
                    if (currentIndex > 0) { newIndex = currentIndex - 1; }
                } else {
                    newIndex = (currentIndex - 1 + totalShorts) % totalShorts;
                }
            } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                if (isFiltered) {
                    if (currentIndex < totalShorts - 1) { newIndex = currentIndex + 1; }
                } else {
                    newIndex = (currentIndex + 1) % totalShorts;
                }
            }

            if (newIndex !== currentIndex) {
                currentIndex = newIndex;
                loadShorts(true);
            }
        });
    });
</script>