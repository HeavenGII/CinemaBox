<div class="page-container profile-page">

    <h1 class="page-title">{{title}}</h1>

    {{>profileNav}}

    <div class="profile-content-area">

        {{#if error}}
            <div class="alert alert-error">{{error}}</div>
        {{/if}}
        {{#if success}}
            <div class="alert alert-success">{{success}}</div>
        {{/if}}
        <form action="/profile/update" method="POST" class="profile-form">
            <h2>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>

            <div class="form-group">
                <label for="email">Email (–õ–æ–≥–∏–Ω)</label>
                <input type="email" id="email" value="{{user.email}}" readonly disabled class="read-only">
            </div>

            <div class="form-group">
                <label for="nickname">–ù–∏–∫–Ω–µ–π–º *</label>
                <input type="text" id="nickname" name="nickname" value="{{user.nickname}}" required>
            </div>

            <div class="form-group">
                <label for="firstName">–ò–º—è</label>
                <input type="text" id="firstName" name="firstName" value="{{user.firstName}}">
            </div>

            <div class="form-group">
                <label for="lastName">–§–∞–º–∏–ª–∏—è</label>
                <input type="text" id="lastName" name="lastName" value="{{user.lastName}}">
            </div>

            <div class="form-group">
                <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="phone" name="phone" value="{{user.phone}}">
            </div>

            <div class="form-group telegram-link-group">
                <label>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram</label>

                {{#if user.telegramId}}
                {{!-- üü¢ –ë–õ–û–ö: –ê–∫–∫–∞—É–Ω—Ç –ø—Ä–∏–≤—è–∑–∞–Ω --}}
                    <input type="text"
                           value="‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω (ID: {{user.telegramId}})"
                           readonly disabled
                           class="read-only text-green-700 font-bold">
                    <p class="text-xs text-green-500 mt-1">
                        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã. ID —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω.
                    </p>
                    <input type="hidden" name="telegramId" value="{{user.telegramId}}">
                {{else}}
                {{!-- üî¥ –ë–õ–û–ö: –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω --}}
                    <input type="text"
                           id="telegram-status-input"
                           value="‚ùå –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É."
                           readonly disabled
                           class="read-only text-red-700">

                    <p class="text-xs text-gray-500 mt-1" id="telegram-link-instruction">
                        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ—ë, —á—Ç–æ–±—ã –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.
                    </p>

                    <button type="button"
                            id="generate-telegram-token"
                            class="btn btn-secondary mt-2">
                        üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram
                    </button>
                    <input type="hidden" name="telegramId" value="">
                {{/if}}
            </div>

            <div class="form-group checkbox-group flex items-center gap-2 mt-4">
                <input type="checkbox"
                       id="enableNotifications"
                       name="enableNotifications"
                       class="h-4 w-4 text-indigo-600 border-gray-300 rounded"
                    {{#if user.enableNotifications}}checked{{/if}}
                    {{#unless user.telegramId}}disabled title="–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞ Telegram-–∞–∫–∫–∞—É–Ω—Ç–∞"{{/unless}}
                >
                <label for="enableNotifications" class="ml-2 block text-sm font-medium text-gray-700">–ü–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–µ–∞–Ω—Å–∞—Ö –≤ Telegram</label>
            </div>

            <button type="submit" class="btn btn-primary profile-submit-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <div class="delete-account-section">
                <p>‚ö†Ô∏è –•–æ—Ç–∏—Ç–µ –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ—é —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å?</p>
                <a href="/profile/delete" class="btn btn-secondary delete-btn">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const generateButton = document.getElementById('generate-telegram-token');
        const statusInput = document.getElementById('telegram-status-input');
        const instructionP = document.getElementById('telegram-link-instruction');

        if (generateButton) {
            generateButton.addEventListener('click', async () => {
                generateButton.disabled = true;
                generateButton.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

                try {
                    const response = await fetch('/profile/telegram/generate-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        const token = result.token;
                        const botUsername = 'CinemaBoxHeavenGII_bot'; // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —é–∑–µ—Ä–Ω–µ–π–º –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
                        const link = `https://t.me/${botUsername}?start=${token}`;

                        statusInput.value = '‚úÖ –°—Å—ã–ª–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞';
                        statusInput.classList.remove('text-red-700');
                        statusInput.classList.add('text-blue-700');

                        instructionP.innerHTML = `
                            –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —ç—Ç—É —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç:
                            <a href="${link}" target="_blank" class="text-indigo-600 hover:underline font-bold block mt-1">${link}</a>
                            <br>
                            * –°—Å—ã–ª–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ 10 –º–∏–Ω—É—Ç.
                        `;

                        // –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
                        window.open(link, '_blank');

                        generateButton.style.display = 'none';

                    } else {
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω.'));
                        generateButton.disabled = false;
                        generateButton.textContent = 'üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram';
                    }
                } catch (error) {
                    console.error(error);
                    alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏.');
                    generateButton.disabled = false;
                    generateButton.textContent = 'üîó –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ Telegram';
                }
            });
        }
    });
</script>