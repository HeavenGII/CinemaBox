<style>
    /* Стили для страницы деталей билета */
    .ticket-view-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
        background-color: #252525; /* Темный фон для карточки */
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        color: #f0f0f0;
    }
    .ticket-header { border-bottom: 2px dashed #444; padding-bottom: 1rem; margin-bottom: 1.5rem; }
    .ticket-info p strong { color: #D12229; }
    .qr-code-section {
        border: 1px solid #333;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        background-color: #1e1e1e; /* Более темный фон для QR */
    }
    .back-link {
        color: #D12229;
        transition: color 0.2s;
        font-weight: 500;
        text-decoration: none;
    }
    .back-link:hover {
        color: #FF4D50;
    }

    /* Индикатор экрана (Стили взяты из примера выбора мест) */
    .screen-indicator {
        width: 100%;
        height: 15px;
        background: linear-gradient(to right, #D12229, #8c171b);
        color: white;
        text-align: center;
        line-height: 10px;
        font-size: 1rem;
        border-radius: 5px 5px 0 0;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(209, 34, 41, 0.4);
        letter-spacing: 0.2em;
    }

    /* Стили схемы зала (минимальные, для отличия) */
    .seat-view-row {
        display: flex;
        gap: 4px;
        justify-content: center;
        margin-bottom: 4px;
    }
    .seat-view {
        width: 20px; height: 20px;
        border-radius: 4px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.6rem;
        font-weight: bold;
        transition: all 0.1s;
    }
    .seat-view.booked { background-color: #444; color: #888; }
    .seat-view.available { background-color: #333; color: #555; }
    .seat-view.user-seat {
        background-color: #D12229;
        color: white;
        border: 2px solid #FF4D50;
        transform: scale(1.2);
        box-shadow: 0 0 5px rgba(209, 34, 41, 0.8);
    }
    .row-view-label { width: 20px; text-align: right; color: #aaa; font-size: 0.7rem; }

    /* Кнопка отмены */
    .cancel-btn {
        background-color: #dc3545 !important;
        color: white !important;
        border-color: #dc3545 !important;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        transition: all 0.2s;
    }
    .cancel-btn:hover {
        background-color: #c82333 !important;
    }
    .status-badge {
        display: inline-block;
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        color: white;
    }

    .status-Оплачен, .status-Забронирован {
        background-color: #28a745;
    }

    .status-Возвращен {
        background-color: #dc3545;
    }

    /* Убираем конфликтные стили Tailwind, чтобы работали стили Handlebars */
    .text-text-muted {
        color: #A0A0A0;
    }

    /* ДОБАВЛЕННЫЙ СТИЛЬ: Контейнер для кнопки отмены с отступом 20px */
    .cancel-button-container {
        margin-top: 20px;
        text-align: center;
    }
</style>

<div class="page-container profile-page">
    <h1 class="page-title">{{title}}</h1>

    <a href="/profile/tickets" class="back-link inline-block mb-4">&larr; Вернуться к билетам</a>

    <div class="ticket-view-page">
        <div class="ticket-header flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold">{{ticket.movie_title}}</h2>
                <p class="text-lg text-text-muted mt-1">{{formatDate ticket.starttime "DD MMMM, HH:mm"}} - {{ticket.hall_name}}</p>
            </div>
            <span class="status-badge status-{{ticket.status}}">{{ticket.status}}</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <h3 class="text-xl font-semibold mb-3">Ваше место: Ряд {{ticket.rownum}}, Место {{ticket.seatnum}}</h3>

                <div class="seating-map-container mt-4 p-4 border border-[#333] rounded-lg bg-[#1E1E1E]">
                    <p class="text-center text-sm text-text-muted mb-3">Схема зала</p>

                    {{!-- ДОБАВЛЕН ИНДИКАТОР ЭКРАНА --}}
                    <div class="screen-indicator mx-auto">ЭКРАН</div>

                    <div id="seating-map-view" class="seating-map mx-auto">
                        <div class="text-center text-text-muted">Загрузка схемы...</div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-1 qr-code-section flex flex-col items-center justify-between">
                <div>
                    <h3 class="text-xl font-semibold mb-3">QR-код для входа</h3>
                    <img src="{{ticket.qrCodeUrl}}" alt="QR Code" class="mx-auto block">
                </div>
                <div class="mt-4 text-center">
                    <p class="text-lg font-bold mt-2">Цена: {{ticket.totalprice}} BYN</p>
                </div>
            </div>
        </div>

        {{#ifeq ticket.status 'Оплачен'}}
        {{!-- ИСПОЛЬЗУЕМ КЛАСС ДЛЯ ОТСТУПА 20PX --}}
            <div class="cancel-button-container">
                <form action="/profile/ticket/{{ticket.ticketid}}/cancel" method="POST" onsubmit="return confirm('Вы уверены, что хотите отменить этот билет? {{ticket.ticketid}}');">
                    <button type="submit" class="btn cancel-btn">
                        Отменить билет
                    </button>
                </form>
            </div>
        {{/ifeq}}

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const seatingMap = document.getElementById('seating-map-view');

        // Данные переданы из Node.js
        const rowsCount = {{ticket.rowscount}};
        const seatsPerRow = {{ticket.seatsperrow}};
        // userSeatKey должен быть в формате 'ряд-место', например, '5-12'
        const userSeatKey = '{{ticket.rownum}}-{{ticket.seatnum}}';

        let bookedSeats = new Set();
        try {
            // Используем JSON.parse для получения массива занятых мест
            const bookedSeatsJson = '{{{bookedSeatKeysJson}}}';
            if (bookedSeatsJson && bookedSeatsJson !== 'undefined') {
                const parsedSeats = JSON.parse(bookedSeatsJson);
                if (Array.isArray(parsedSeats)) {
                    // Фильтруем, чтобы не добавлять само место пользователя в booked,
                    // даже если оно пришло в списке (например, если API не исключает его)
                    parsedSeats.forEach(key => {
                        if (key !== userSeatKey) {
                            bookedSeats.add(key);
                        }
                    });
                }
            }
        } catch (e) {
            console.error("Не удалось распарсить bookedSeats JSON:", e);
        }

        function renderSeatingMap() {
            if (rowsCount <= 0 || seatsPerRow <= 0) {
                seatingMap.innerHTML = '<div class="text-center text-text-muted mt-4">Ошибка: Некорректные размеры зала.</div>';
                return;
            }

            seatingMap.innerHTML = '';
            for (let row = 1; row <= rowsCount; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'seat-view-row';

                const rowLabel = document.createElement('div');
                rowLabel.className = 'row-view-label';
                rowLabel.textContent = row;
                rowDiv.appendChild(rowLabel);

                for (let seatNum = 1; seatNum <= seatsPerRow; seatNum++) {
                    const seatKey = `${row}-${seatNum}`;
                    const seatDiv = document.createElement('div');
                    seatDiv.className = 'seat-view';
                    seatDiv.textContent = seatNum;

                    if (seatKey === userSeatKey) {
                        seatDiv.classList.add('user-seat');
                    } else if (bookedSeats.has(seatKey)) {
                        seatDiv.classList.add('booked');
                    } else {
                        // Для деталей билета нам не нужно показывать "available" как кликабельное,
                        // поэтому можно использовать тот же стиль, что и для booked, но без класса user-seat.
                        seatDiv.classList.add('booked');
                    }

                    rowDiv.appendChild(seatDiv);
                }
                seatingMap.appendChild(rowDiv);
            }
        }

        renderSeatingMap();
    });
</script>